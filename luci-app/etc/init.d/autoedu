#!/bin/sh /etc/rc.common
# Copyright (C) 2025 Matsumiko

START=95
STOP=10

USE_PROCD=1

SCRIPT_DIR="/usr/share/autoedu"
SCRIPT_FILE="$SCRIPT_DIR/auto_edu.py"
ENV_FILE="/root/Auto-Edu/auto_edu.env"
LOG_FILE="/tmp/auto_edu.log"

start_service() {
	local enabled mode interval
	
	config_load autoedu
	config_get enabled config enabled 0
	config_get mode config mode 'EFFICIENT'
	
	[ "$enabled" -eq 0 ] && {
		logger -t autoedu "Service disabled in config"
		return 1
	}
	
	# Check if script exists
	[ ! -f "$SCRIPT_FILE" ] && {
		logger -t autoedu "Script not found: $SCRIPT_FILE"
		return 1
	}
	
	# Sync UCI to .env
	/usr/share/autoedu/sync_config.sh
	
	# Determine cron interval based on mode
	if [ "$mode" = "AGGRESSIVE" ]; then
		interval="*/1 * * * *"
	else
		interval="*/3 * * * *"
	fi
	
	# Setup cron job
	logger -t autoedu "Setting up cron: $interval (Mode: $mode)"
	
	# Remove old cron entries
	crontab -l 2>/dev/null | grep -v "auto_edu.py" | crontab - 2>/dev/null || true
	
	# Add new cron entry
	(crontab -l 2>/dev/null; echo "$interval AUTO_EDU_ENV=$ENV_FILE /usr/bin/python3 $SCRIPT_FILE >> $LOG_FILE 2>&1") | crontab -
	
	# Restart cron
	/etc/init.d/cron restart >/dev/null 2>&1
	
	logger -t autoedu "Service started (Mode: $mode, Interval: $interval)"
	
	# Start API server if available
	if [ -f "$SCRIPT_DIR/web_api.py" ]; then
		procd_open_instance api
		procd_set_param command /usr/bin/python3 "$SCRIPT_DIR/web_api.py"
		procd_set_param respawn 3600 5 0
		procd_set_param stdout 1
		procd_set_param stderr 1
		procd_close_instance
		logger -t autoedu "API server started"
	fi
}

stop_service() {
	logger -t autoedu "Stopping service"
	
	# Remove cron job
	crontab -l 2>/dev/null | grep -v "auto_edu.py" | crontab - 2>/dev/null || true
	
	# Restart cron to apply changes
	/etc/init.d/cron restart >/dev/null 2>&1
	
	# Stop API server
	killall -9 python3 2>/dev/null || true
	
	logger -t autoedu "Service stopped"
}

service_triggers() {
	procd_add_reload_trigger "autoedu"
}

reload_service() {
	logger -t autoedu "Reloading service"
	stop
	start
}
