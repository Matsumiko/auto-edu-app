<%#
Copyright 2025 Matsumiko
Licensed under the Apache License, Version 2.0
-%>

<%+header%>

<style>
/* Import font untuk konsistensi */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

* {
	font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

/* Background gradient matching dashboard */
body {
	background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
	background-attachment: fixed;
	min-height: 100vh;
}

.autoedu-status {
	max-width: 1280px;
	margin: 20px auto;
	padding: 0 16px;
	box-sizing: border-box;
	animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
	from {
		opacity: 0;
		transform: translateY(20px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

/* Header Section */
.status-header {
	text-align: center;
	margin-bottom: 32px;
	padding: 24px;
	background: rgba(15, 23, 42, 0.6);
	backdrop-filter: blur(20px);
	-webkit-backdrop-filter: blur(20px);
	border-radius: 24px;
	border: 1px solid rgba(148, 163, 253, 0.2);
	box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
	position: relative;
	overflow: hidden;
}

.status-header::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	height: 3px;
	background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #3b82f6);
	background-size: 200% 100%;
	animation: gradientShift 3s ease infinite;
}

@keyframes gradientShift {
	0%, 100% { background-position: 0% 50%; }
	50% { background-position: 100% 50%; }
}

.autoedu-status h2 {
	margin: 0 0 12px;
	font-size: 2.5rem;
	font-weight: 800;
	letter-spacing: -0.02em;
	background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
	-webkit-background-clip: text;
	background-clip: text;
	color: transparent;
	animation: titleGlow 2s ease-in-out infinite;
}

@keyframes titleGlow {
	0%, 100% { filter: brightness(1); }
	50% { filter: brightness(1.2); }
}

.status-subtitle {
	color: #cbd5e1;
	font-size: 1rem;
	opacity: 0.9;
	font-weight: 500;
}

/* Grid Layout */
.status-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
	gap: 20px;
	margin-top: 8px;
}

/* Test Card - Modern glass design */
.test-card {
	background: rgba(15, 23, 42, 0.7);
	backdrop-filter: blur(20px);
	-webkit-backdrop-filter: blur(20px);
	border: 1px solid rgba(148, 163, 253, 0.15);
	border-radius: 20px;
	padding: 24px;
	box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	position: relative;
	overflow: hidden;
	animation: cardSlideIn 0.6s ease-out backwards;
}

.test-card:nth-child(1) { animation-delay: 0.1s; }
.test-card:nth-child(2) { animation-delay: 0.2s; }
.test-card:nth-child(3) { animation-delay: 0.3s; }

@keyframes cardSlideIn {
	from {
		opacity: 0;
		transform: translateY(30px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.test-card:hover {
	transform: translateY(-4px);
	box-shadow: 0 12px 48px rgba(59, 130, 246, 0.2);
	border-color: rgba(148, 163, 253, 0.3);
}

.test-card::before {
	content: '';
	position: absolute;
	top: 0;
	left: 0;
	right: 0;
	height: 2px;
	background: linear-gradient(90deg, transparent, #3b82f6, transparent);
	opacity: 0;
	transition: opacity 0.3s ease;
}

.test-card:hover::before {
	opacity: 1;
}

/* Card Header */
.test-card h3 {
	margin: 0 0 20px;
	font-size: 1.25rem;
	font-weight: 700;
	color: #f1f5f9;
	display: flex;
	align-items: center;
	gap: 12px;
	letter-spacing: -0.01em;
	padding-bottom: 16px;
	border-bottom: 1px solid rgba(148, 163, 253, 0.1);
}

.test-card h3::before {
	content: "üîå";
	font-size: 1.5rem;
}

/* Test Section */
.test-section {
	margin-bottom: 20px;
	padding: 16px;
	background: linear-gradient(135deg, rgba(15, 23, 42, 0.6), rgba(30, 41, 59, 0.6));
	border-radius: 16px;
	border: 1px solid rgba(148, 163, 253, 0.1);
	transition: all 0.3s ease;
}

.test-section:hover {
	background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.8));
	border-color: rgba(148, 163, 253, 0.2);
}

.test-section:last-child {
	margin-bottom: 0;
}

.test-card h4 {
	margin: 0 0 12px;
	font-size: 1rem;
	font-weight: 600;
	color: #e0e7ff;
	display: flex;
	align-items: center;
	gap: 8px;
}

.test-card h4::before {
	content: '';
	width: 6px;
	height: 6px;
	border-radius: 50%;
	background: linear-gradient(135deg, #3b82f6, #8b5cf6);
	box-shadow: 0 0 8px rgba(59, 130, 246, 0.6);
}

/* Modern Test Button */
.cbi-button {
	padding: 12px 24px;
	border: none;
	border-radius: 12px;
	cursor: pointer;
	font-size: 0.875rem;
	font-weight: 600;
	transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
	display: inline-flex;
	align-items: center;
	justify-content: center;
	gap: 8px;
	background: linear-gradient(135deg, #3b82f6, #6366f1);
	color: white;
	box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
	position: relative;
	overflow: hidden;
	letter-spacing: 0.02em;
	width: 100%;
}

.cbi-button::before {
	content: '';
	position: absolute;
	inset: 0;
	background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
	opacity: 0;
	transition: opacity 0.3s ease;
}

.cbi-button:hover::before {
	opacity: 1;
}

.cbi-button:hover {
	box-shadow: 0 8px 24px rgba(59, 130, 246, 0.5);
	transform: translateY(-2px);
}

.cbi-button:active {
	transform: translateY(0) scale(0.98);
}

.cbi-button:disabled {
	opacity: 0.5;
	cursor: not-allowed;
	transform: none !important;
}

.cbi-button.testing {
	background: linear-gradient(135deg, #8b5cf6, #a78bfa);
	animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
	0%, 100% {
		box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
	}
	50% {
		box-shadow: 0 8px 24px rgba(139, 92, 246, 0.6);
	}
}

/* Test Result Box - Enhanced */
.test-result {
	margin-top: 12px;
	padding: 16px;
	border-radius: 12px;
	font-size: 0.875rem;
	line-height: 1.6;
	position: relative;
	overflow: hidden;
	animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
	from {
		opacity: 0;
		transform: translateY(-10px);
	}
	to {
		opacity: 1;
		transform: translateY(0);
	}
}

.test-result::before {
	content: '';
	position: absolute;
	left: 0;
	top: 0;
	bottom: 0;
	width: 4px;
}

/* Success State */
.test-success {
	background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(22, 163, 74, 0.15));
	color: #86efac;
	border: 1px solid rgba(34, 197, 94, 0.4);
	box-shadow: 0 4px 12px rgba(34, 197, 94, 0.1);
}

.test-success::before {
	background: linear-gradient(180deg, #22c55e, #16a34a);
}

.test-success .result-icon {
	color: #22c55e;
	font-size: 1.5rem;
	animation: successBounce 0.5s ease-out;
}

@keyframes successBounce {
	0%, 100% { transform: scale(1); }
	50% { transform: scale(1.2); }
}

/* Error State */
.test-error {
	background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
	color: #fca5a5;
	border: 1px solid rgba(239, 68, 68, 0.4);
	box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
}

.test-error::before {
	background: linear-gradient(180deg, #ef4444, #dc2626);
}

.test-error .result-icon {
	color: #ef4444;
	font-size: 1.5rem;
	animation: errorShake 0.5s ease-out;
}

@keyframes errorShake {
	0%, 100% { transform: translateX(0); }
	25% { transform: translateX(-5px); }
	75% { transform: translateX(5px); }
}

/* Loading State */
.test-loading {
	background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.15));
	color: #93c5fd;
	border: 1px solid rgba(59, 130, 246, 0.4);
	box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.test-loading::before {
	background: linear-gradient(180deg, #3b82f6, #6366f1);
}

.test-loading .loading-spinner {
	display: inline-block;
	animation: spin 1s linear infinite;
	font-size: 1.2rem;
	margin-right: 8px;
}

@keyframes spin {
	from { transform: rotate(0deg); }
	to { transform: rotate(360deg); }
}

/* Result Content */
.result-header {
	display: flex;
	align-items: center;
	gap: 12px;
	margin-bottom: 8px;
	font-weight: 600;
	font-size: 1rem;
}

.result-details {
	margin-top: 12px;
	padding-top: 12px;
	border-top: 1px solid rgba(148, 163, 253, 0.1);
	font-size: 0.8rem;
	opacity: 0.9;
}

.result-detail-item {
	display: flex;
	justify-content: space-between;
	margin: 6px 0;
	padding: 4px 0;
}

.result-detail-label {
	color: #94a3b8;
	font-weight: 500;
}

.result-detail-value {
	font-weight: 600;
	font-family: 'JetBrains Mono', 'Fira Code', monospace;
}

/* Info Card - System Status */
.info-card {
	background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
	border: 1px solid rgba(139, 92, 246, 0.3);
	border-radius: 16px;
	padding: 20px;
	margin-bottom: 20px;
	display: flex;
	align-items: center;
	gap: 16px;
}

.info-card-icon {
	font-size: 2.5rem;
	animation: float 3s ease-in-out infinite;
}

@keyframes float {
	0%, 100% { transform: translateY(0); }
	50% { transform: translateY(-10px); }
}

.info-card-content h4 {
	margin: 0 0 8px;
	font-size: 1rem;
	font-weight: 700;
	color: #e0e7ff;
}

.info-card-content p {
	margin: 0;
	font-size: 0.875rem;
	color: #94a3b8;
	line-height: 1.5;
}

/* Responsive Design */
@media (max-width: 968px) {
	.status-grid {
		grid-template-columns: 1fr;
	}
}

@media (max-width: 640px) {
	.autoedu-status {
		padding: 0 12px;
	}

	.autoedu-status h2 {
		font-size: 2rem;
	}

	.test-card {
		padding: 16px;
	}

	.test-section {
		padding: 12px;
	}

	.info-card {
		flex-direction: column;
		text-align: center;
	}
}

/* Tooltip for additional info */
.tooltip {
	position: relative;
	display: inline-block;
	cursor: help;
	margin-left: 4px;
	color: #94a3b8;
}

.tooltip:hover {
	color: #60a5fa;
}

.tooltip .tooltiptext {
	visibility: hidden;
	width: 200px;
	background-color: rgba(15, 23, 42, 0.95);
	color: #e0e7ff;
	text-align: center;
	border-radius: 8px;
	padding: 8px;
	position: absolute;
	z-index: 1;
	bottom: 125%;
	left: 50%;
	margin-left: -100px;
	opacity: 0;
	transition: opacity 0.3s;
	font-size: 0.75rem;
	border: 1px solid rgba(148, 163, 253, 0.2);
}

.tooltip:hover .tooltiptext {
	visibility: visible;
	opacity: 1;
}
</style>

<div class="autoedu-status">
	<div class="status-header">
		<h2>üîç System Diagnostics</h2>
		<p class="status-subtitle">Test & verify AutoEdu system components</p>
	</div>

	<div class="info-card">
		<div class="info-card-icon">üß™</div>
		<div class="info-card-content">
			<h4>Connection Testing</h4>
			<p>Gunakan tools di bawah untuk test koneksi Telegram Bot, ADB Device, dan SMS access. 
			Pastikan semua components berfungsi dengan baik sebelum menjalankan AutoEdu.</p>
		</div>
	</div>

	<div class="status-grid">
		<!-- Telegram Test Card -->
		<div class="test-card">
			<h3>Telegram Bot Test</h3>
			
			<div class="test-section">
				<h4>
					Connection Test
					<span class="tooltip">‚ÑπÔ∏è
						<span class="tooltiptext">Test koneksi ke Telegram Bot API dan verifikasi token</span>
					</span>
				</h4>
				<button class="cbi-button" onclick="testConnection('telegram')" id="btn-telegram">
					üß™ Test Telegram Connection
				</button>
				<div id="test-telegram-result"></div>
			</div>
		</div>

		<!-- ADB Test Card -->
		<div class="test-card">
			<h3>ADB Device Test</h3>
			
			<div class="test-section">
				<h4>
					Device Detection
					<span class="tooltip">‚ÑπÔ∏è
						<span class="tooltiptext">Detect ADB device connection dan verifikasi device ID</span>
					</span>
				</h4>
				<button class="cbi-button" onclick="testConnection('adb')" id="btn-adb">
					üß™ Test ADB Device
				</button>
				<div id="test-adb-result"></div>
			</div>
		</div>

		<!-- SMS Test Card -->
		<div class="test-card">
			<h3>SMS Access Test</h3>
			
			<div class="test-section">
				<h4>
					SMS Permission
					<span class="tooltip">‚ÑπÔ∏è
						<span class="tooltiptext">Verify SMS read access pada device untuk auto-renewal</span>
					</span>
				</h4>
				<button class="cbi-button" onclick="testConnection('sms')" id="btn-sms">
					üß™ Test SMS Access
				</button>
				<div id="test-sms-result"></div>
			</div>
		</div>
	</div>
</div>

<script>
const API_BASE = '<%=url("admin/services/autoedu/api")%>';

async function testConnection(type) {
	const resultDiv = document.getElementById(`test-${type}-result`);
	const button = document.getElementById(`btn-${type}`);
	
	// Show loading state
	button.classList.add('testing');
	button.disabled = true;
	
	resultDiv.innerHTML = `
		<div class="test-result test-loading">
			<div class="result-header">
				<span class="loading-spinner">‚ö°</span>
				<span>Testing connection...</span>
			</div>
		</div>
	`;

	try {
		const formData = new FormData();
		formData.append('type', type);

		const resp = await fetch(API_BASE + '/test', {
			method: 'POST',
			body: formData
		});

		const result = await resp.json();
		const ok = !!result.success;

		// Render result with enhanced UI
		const className = ok ? 'test-success' : 'test-error';
		const icon = ok ? '‚úÖ' : '‚ùå';
		const iconClass = ok ? 'result-icon' : 'result-icon';
		
		let detailsHTML = '';
		
		// Add specific details based on test type
		if (result.device || result.error || result.details) {
			detailsHTML = '<div class="result-details">';
			
			if (result.device) {
				detailsHTML += `
					<div class="result-detail-item">
						<span class="result-detail-label">Device:</span>
						<span class="result-detail-value">${escapeHtml(result.device)}</span>
					</div>
				`;
			}
			
			if (result.details) {
				for (const [key, value] of Object.entries(result.details)) {
					detailsHTML += `
						<div class="result-detail-item">
							<span class="result-detail-label">${escapeHtml(key)}:</span>
							<span class="result-detail-value">${escapeHtml(String(value))}</span>
						</div>
					`;
				}
			}
			
			if (result.error) {
				detailsHTML += `
					<div class="result-detail-item">
						<span class="result-detail-label">Error:</span>
						<span class="result-detail-value" style="color: #fca5a5;">${escapeHtml(result.error)}</span>
					</div>
				`;
			}
			
			detailsHTML += '</div>';
		}

		resultDiv.innerHTML = `
			<div class="test-result ${className}">
				<div class="result-header">
					<span class="${iconClass}">${icon}</span>
					<span>${escapeHtml(result.message || (ok ? 'Test berhasil!' : 'Test gagal!'))}</span>
				</div>
				${detailsHTML}
			</div>
		`;

		// Show notification
		showNotification(
			ok ? `‚úÖ ${type.toUpperCase()} test berhasil!` : `‚ùå ${type.toUpperCase()} test gagal!`,
			ok ? 'success' : 'error'
		);

	} catch (error) {
		resultDiv.innerHTML = `
			<div class="test-result test-error">
				<div class="result-header">
					<span class="result-icon">‚ùå</span>
					<span>Connection Error</span>
				</div>
				<div class="result-details">
					<div class="result-detail-item">
						<span class="result-detail-label">Error:</span>
						<span class="result-detail-value" style="color: #fca5a5;">${escapeHtml(error.message)}</span>
					</div>
				</div>
			</div>
		`;
		
		showNotification(`‚ùå Error: ${error.message}`, 'error');
	} finally {
		// Remove loading state
		button.classList.remove('testing');
		button.disabled = false;
	}
}

function escapeHtml(text) {
	const div = document.createElement('div');
	div.textContent = text;
	return div.innerHTML;
}

function showNotification(message, type = 'info') {
	// Simple alert for now - bisa diganti dengan toast notification yang lebih fancy
	console.log(`[${type.toUpperCase()}] ${message}`);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
	// Ctrl/Cmd + T untuk test semua
	if ((e.ctrlKey || e.metaKey) && e.key === 't') {
		e.preventDefault();
		testConnection('telegram');
		setTimeout(() => testConnection('adb'), 1000);
		setTimeout(() => testConnection('sms'), 2000);
	}
});

// Auto-test on load (optional - bisa di-enable kalau mau)
// window.addEventListener('load', function() {
//     setTimeout(() => testConnection('telegram'), 500);
//     setTimeout(() => testConnection('adb'), 1500);
//     setTimeout(() => testConnection('sms'), 2500);
// });
</script>

<%+footer%>
