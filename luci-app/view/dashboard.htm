<%#
Copyright 2025 Matsumiko
Licensed under the Apache License, Version 2.0
-%>

<%+header%>

<style>

/* Container utama, center, transparan */
.autoedu-dashboard {
	max-width: 1200px;
	margin: 16px auto 20px;
	padding: 0 4px 4px;
	box-sizing: border-box;
	background: transparent;
}

/* Title + sub header */
.autoedu-dashboard h2 {
	margin: 0 0 8px;
	font-size: 1.7rem;
	font-weight: 800;
	letter-spacing: 0.03em;
	background: linear-gradient(90deg, #38bdf8, #6366f1);
	-webkit-background-clip: text;
	color: transparent;
	text-shadow: 0 0 10px rgba(15,23,42,0.9);
	display: flex;
	align-items: center;
	gap: 6px;
}

.autoedu-subtitle {
	margin: 0 0 14px;
	font-size: 0.8rem;
	color: #e5e7eb;
	opacity: 0.9;
	text-shadow: 0 0 8px rgba(15,23,42,1);
}

/* Badge kecil di samping title */
.autoedu-badges {
	display: flex;
	flex-wrap: wrap;
	gap: 6px;
	margin-bottom: 10px;
}

.autoedu-pill {
	padding: 3px 10px;
	border-radius: 999px;
	font-size: 0.7rem;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	color: #e5e7eb;
	background: rgba(17,24,39,0.96);
	backdrop-filter: blur(8px);
	-webkit-backdrop-filter: blur(8px);
	border: 1px solid rgba(148,163,253,0.32);
	box-shadow: 0 4px 14px rgba(15,23,42,0.95);
}

/* Kartu utama: dark glass, mirip navbar Argon, no putih susu */
.status-card {
	background: rgba(15,23,42,0.92);
	backdrop-filter: blur(8px);
	-webkit-backdrop-filter: blur(8px);
	border: 1px solid rgba(75,85,99,0.9);
	border-radius: 16px;
	padding: 11px 12px 10px;
	margin-bottom: 10px;
	box-shadow: 0 10px 26px rgba(15,23,42,0.95);
	color: #e5e7eb;
}

/* Judul card */
.status-card h3 {
	margin: 0 0 6px;
	font-size: 0.95rem;
	font-weight: 600;
	color: #f9fafb;
	display: flex;
	align-items: center;
	gap: 8px;
}

.status-card h3::before {
	content: "";
	width: 18px;
	height: 18px;
	border-radius: 8px;
	background: radial-gradient(circle at 30% 0, #38bdf8, #4f46e5);
	box-shadow: 0 3px 8px rgba(15,23,42,0.9);
}

/* Indicator status */
.status-indicator {
	display: inline-block;
	width: 9px;
	height: 9px;
	border-radius: 999px;
	margin-right: 6px;
	box-shadow: 0 0 0 0 rgba(22,163,74,0.7);
	animation: pulse 1.8s infinite;
}

@keyframes pulse {
	0% { transform: scale(0.9); opacity: 1; }
	70% { transform: scale(1.25); opacity: 0; }
	100% { transform: scale(0.9); opacity: 0; }
}

.status-running { 
	background: #22c55e;
}

.status-stopped { 
	background: #f97316;
}

/* Grid info */
.status-info {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
	gap: 6px;
	margin-top: 4px;
}

.info-item {
	padding: 7px 8px 6px;
	background: rgba(9,9,11,0.96);
	backdrop-filter: blur(4px);
	-webkit-backdrop-filter: blur(4px);
	border-radius: 10px;
	border: 1px solid rgba(75,85,99,0.9);
	transition: all 0.16s ease;
}

.info-item:hover {
	transform: translateY(-1px);
	box-shadow: 0 5px 14px rgba(15,23,42,0.95);
}

.info-label {
	font-weight: 600;
	color: #9ca3af;
	font-size: 0.66rem;
	text-transform: uppercase;
	letter-spacing: 0.08em;
}

.info-value {
	color: #f9fafb;
	font-size: 0.84rem;
	margin-top: 3px;
	font-weight: 500;
}

.info-note,
.info-item small {
	display: block;
	font-size: 0.63rem;
	color: #9ca3af;
	margin-top: 2px;
}

/* Mode badge */
.mode-badge {
	display: inline-flex;
	align-items: center;
	gap: 5px;
	padding: 3px 9px;
	border-radius: 999px;
	font-weight: 600;
	font-size: 0.66rem;
	letter-spacing: 0.06em;
	text-transform: uppercase;
}

.mode-efficient {
	background: rgba(22,163,74,0.16);
	color: #bbf7d0;
	border: 1px solid rgba(22,163,74,0.9);
}

.mode-aggressive {
	background: rgba(249,115,22,0.16);
	color: #fed7aa;
	border: 1px solid rgba(249,115,22,0.9);
}

/* Buttons */
.btn-group {
	display: flex;
	gap: 6px;
	margin-top: 8px;
	flex-wrap: wrap;
}

.btn {
	padding: 7px 13px;
	border: none;
	border-radius: 9px;
	cursor: pointer;
	font-size: 0.76rem;
	font-weight: 500;
	transition: all 0.18s;
	text-decoration: none;
	display: inline-flex;
	align-items: center;
	gap: 6px;
	background: rgba(0,0,0,0.96);
	color: #e5e7eb;
	box-shadow: 0 4px 14px rgba(15,23,42,1);
}

.btn-primary { 
	background: linear-gradient(90deg, #3b82f6, #6366f1);
}

.btn-success { 
	background: linear-gradient(90deg, #22c55e, #16a34a);
}

.btn-danger { 
	background: linear-gradient(90deg, #ef4444, #b91c1c);
}

.btn-warning { 
	background: linear-gradient(90deg, #f97316, #facc15);
	color: #111827; 
}

.btn:hover { 
	opacity: 0.98;
	transform: translateY(-1px);
	box-shadow: 0 7px 18px rgba(15,23,42,1);
}

.btn:disabled { 
	opacity: 0.35; 
	cursor: not-allowed;
	transform: none;
	box-shadow: none;
}

/* Stats */
.stats-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
	gap: 6px;
	margin-top: 4px;
}

.stat-box {
	text-align: left;
	padding: 7px 8px 7px;
	background: rgba(9,9,11,0.96);
	backdrop-filter: blur(4px);
	-webkit-backdrop-filter: blur(4px);
	color: #e5e7eb;
	border-radius: 10px;
	border: 1px solid rgba(59,130,246,0.4);
	box-shadow: 0 5px 14px rgba(15,23,42,1);
}

.stat-label {
	font-size: 0.66rem;
	text-transform: uppercase;
	letter-spacing: 0.08em;
	color: #bfdbfe;
	margin-bottom: 1px;
}

.stat-value {
	font-size: 1.26rem;
	font-weight: 700;
}

/* Log viewer */
.log-viewer {
	background: rgba(0,0,0,0.98);
	color: #d4d4d4;
	padding: 8px 9px 7px;
	border-radius: 9px;
	font-family: 'JetBrains Mono','Fira Code','Consolas',monospace;
	font-size: 0.7rem;
	max-height: 260px;
	overflow-y: auto;
	margin-top: 6px;
	border: 1px solid rgba(75,85,99,1);
	box-shadow: inset 0 3px 8px rgba(15,23,42,1);
}

.log-line {
	margin: 1px 0;
	line-height: 1.5;
	padding: 1px 0;
	white-space: pre-wrap;
	word-break: break-word;
}

.log-info { color: #38bdf8; }
.log-success { color: #4ade80; }
.log-warn { color: #ffb74d; }
.log-error { color: #e57373; }

.loading {
	text-align: left;
	padding: 6px 0;
	color: #9ca3af;
	font-style: italic;
	font-size: 0.72rem;
}

/* Scrollbar styling */
.log-viewer::-webkit-scrollbar {
	width: 6px;
}
.log-viewer::-webkit-scrollbar-track {
	background: transparent;
}
.log-viewer::-webkit-scrollbar-thumb {
	background: #4b5563;
	border-radius: 999px;
}
.log-viewer::-webkit-scrollbar-thumb:hover {
	background: #9ca3af;
}

/* Responsive */
@media (max-width: 768px) {
	.autoedu-dashboard {
		margin: 12px 4px 16px;
	}
	.status-info {
		grid-template-columns: 1fr;
	}
	.btn-group {
		flex-direction: row;
		flex-wrap: wrap;
	}
	.btn {
		flex: 1 1 calc(50% - 4px);
		justify-content: center;
	}
}
</style>

<div class="autoedu-dashboard">
	<h2>ü§ñ AutoEdu Control Center</h2>
	<p class="autoedu-subtitle">
		Monitor status AutoEdu, cron, ADB, dan log via Web.
	</p>
	<div class="autoedu-badges">
		<div class="autoedu-pill">‚ö° Auto refresh tiap 30 detik</div>
		<div class="autoedu-pill">üß† Smart auto-renewal monitor</div>
	</div>
	
	<!-- Service Status Card -->
	<div class="status-card">
		<h3>Service Status</h3>
		<div id="service-status" class="loading">Loading...</div>
		
		<div class="btn-group" id="action-buttons" style="display:none;">
			<button class="btn btn-success" onclick="performAction('start')" id="btn-start">
				‚ñ∂Ô∏è Start Service
			</button>
			<button class="btn btn-danger" onclick="performAction('stop')" id="btn-stop">
				‚è∏ Stop Service
			</button>
			<button class="btn btn-warning" onclick="performAction('restart')">
				üîÑ Restart
			</button>
			<button class="btn btn-primary" onclick="performAction('run_now')">
				‚ö° Run Now
			</button>
		</div>
	</div>
	
	<!-- Current Configuration Card -->
	<div class="status-card">
		<h3>Current Configuration</h3>
		<div id="config-info" class="loading">Loading...</div>
	</div>
	
	<!-- Statistics Card -->
	<div class="status-card">
		<h3>Statistics (Last 24h)</h3>
		<div id="statistics" class="loading">Loading...</div>
	</div>
	
	<!-- Recent Logs Card -->
	<div class="status-card">
		<h3>Recent Activity</h3>
		<div class="btn-group">
			<button class="btn btn-primary" onclick="refreshLogs()">üîÑ Refresh Logs</button>
			<button class="btn btn-danger" onclick="clearLogs()">üóë Clear Logs</button>
			<a href="<%=url("admin/services/autoedu/logs")%>" class="btn btn-primary">üìú View Full Logs</a>
		</div>
		<div class="log-viewer" id="log-viewer">
			<div class="loading">Loading logs...</div>
		</div>
	</div>
</div>

<script>
const API_BASE = '<%=url("admin/services/autoedu/api")%>';

// Load dashboard data
async function loadDashboard() {
	try {
		const statusResp = await fetch(API_BASE + '/status');
		const status = await statusResp.json();
		renderStatus(status);

		const statsResp = await fetch(API_BASE + '/stats');
		const stats = await statsResp.json();
		renderStats(stats);

		await refreshLogs();
	} catch (error) {
		console.error('Error loading dashboard:', error);
	}
}

// Render service status
function renderStatus(status) {
	const statusDiv = document.getElementById('service-status');
	const actionButtons = document.getElementById('action-buttons');

	const modeClass = status.mode === 'AGGRESSIVE' ? 'mode-aggressive' : 'mode-efficient';
	const modeIcon = status.mode === 'AGGRESSIVE' ? 'üî¥' : 'üü¢';
	const modeText = status.mode === 'AGGRESSIVE' ? 'AGGRESSIVE' : 'EFFICIENT';

	const isRunning = status.enabled && status.cron_active;
	const statusIcon = isRunning
		? '<span class="status-indicator status-running"></span>Running'
		: '<span class="status-indicator status-stopped"></span>Stopped';

	const statusColor = isRunning ? '#22c55e' : '#f97316';

	statusDiv.innerHTML = `
		<div class="status-info">
			<div class="info-item">
				<div class="info-label">Status Service</div>
				<div class="info-value" style="color:${statusColor}; font-weight:700;">${statusIcon}</div>
				<div class="info-note">
					${status.enabled ? '‚úì Enabled in config' : '‚úó Disabled in config'}<br>
					${status.cron_active ? '‚úì Cron job active' : '‚úó No cron job detected'}
				</div>
			</div>
			<div class="info-item">
				<div class="info-label">Mode Operasi</div>
				<div class="info-value">
					<span class="mode-badge ${modeClass}">${modeIcon} ${modeText}</span>
				</div>
				<div class="info-note">
					EFFICIENT = aman & stabil ‚Ä¢ AGGRESSIVE = fokus perpanjang secepat mungkin.
				</div>
			</div>
			<div class="info-item">
				<div class="info-label">Last Check</div>
				<div class="info-value">${status.last_check || 'Never'}</div>
				${status.last_check_ago ? `<div class="info-note">${status.last_check_ago}</div>` : ''}
			</div>
			<div class="info-item">
				<div class="info-label">Last Renewal</div>
				<div class="info-value">${status.last_renewal || 'Never'}</div>
				${status.last_renewal_ago ? `<div class="info-note">${status.last_renewal_ago}</div>` : ''}
			</div>
			<div class="info-item">
				<div class="info-label">Cron Schedule</div>
				<div class="info-value">${status.cron_readable || 'Not configured'}</div>
				${status.next_check ? `<div class="info-note">Next: ${status.next_check}</div>` : ''}
			</div>
			<div class="info-item">
				<div class="info-label">ADB Device</div>
				<div class="info-value">
					${status.adb_connected
						? '‚úÖ ' + (status.adb_device || 'Connected')
						: '‚ùå Disconnected'}
				</div>
				<div class="info-note">
					${status.adb_connected ? 'Device siap automation.' : 'Pastikan ADB aktif & terkoneksi.'}
				</div>
			</div>
		</div>
	`;

	actionButtons.style.display = 'flex';
	document.getElementById('btn-start').disabled = isRunning;
	document.getElementById('btn-stop').disabled = !isRunning;

	// Config info
	const configDiv = document.getElementById('config-info');
	configDiv.innerHTML = `
		<div class="status-info">
			<div class="info-item">
				<div class="info-label">Telegram Bot</div>
				<div class="info-value">
					${status.telegram_configured ? '‚úÖ Configured' : '‚ùå Not configured'}
				</div>
				<div class="info-note">
					${status.telegram_configured
						? 'Notifikasi via bot aktif.'
						: 'Set token & chat ID di menu Config.'}
				</div>
			</div>
			<div class="info-item">
				<div class="info-label">Service</div>
				<div class="info-value">${status.enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</div>
				<div class="info-note">Mengontrol apakah AutoEdu dipakai atau tidak.</div>
			</div>
			<div class="info-item">
				<div class="info-label">Auto Start / Cron</div>
				<div class="info-value">${status.cron_active ? '‚úÖ Active' : '‚ùå Inactive'}</div>
				<div class="info-note">Cron wajib aktif untuk jalan otomatis.</div>
			</div>
		</div>
		<div class="btn-group">
			<a href="<%=url("admin/services/autoedu/config")%>" class="btn btn-primary">‚úèÔ∏è Edit Configuration</a>
			<a href="<%=url("admin/services/autoedu/mode")%>" class="btn btn-warning">üéöÔ∏è Change Mode</a>
		</div>
	`;
}

// Render statistics
function renderStats(stats) {
	const statsDiv = document.getElementById('statistics');
	statsDiv.innerHTML = `
		<div class="stats-grid">
			<div class="stat-box">
				<div class="stat-label">Total Checks</div>
				<div class="stat-value">${stats.checks_24h || 0}</div>
			</div>
			<div class="stat-box">
				<div class="stat-label">Renewals</div>
				<div class="stat-value">${stats.renewals_24h || 0}</div>
			</div>
			<div class="stat-box">
				<div class="stat-label">Success Rate</div>
				<div class="stat-value">${stats.success_rate != null ? stats.success_rate : 100}%</div>
			</div>
		</div>
	`;
}

// Refresh logs
async function refreshLogs() {
	try {
		const resp = await fetch(API_BASE + '/logs?lines=50');
		const data = await resp.json();
		const logViewer = document.getElementById('log-viewer');

		if (data.success && data.logs.length > 0) {
			logViewer.innerHTML = data.logs.map(line => {
				let className = 'log-line';
				if (line.includes('[ERROR]')) className += ' log-error';
				else if (line.includes('[WARN]')) className += ' log-warn';
				else if (line.includes('[SUCCESS]')) className += ' log-success';
				else if (line.includes('[INFO]')) className += ' log-info';
				return `<div class="${className}">${escapeHtml(line)}</div>`;
			}).join('');
			logViewer.scrollTop = logViewer.scrollHeight;
		} else {
			logViewer.innerHTML = '<div class="loading">No logs available</div>';
		}
	} catch (error) {
		console.error('Error loading logs:', error);
		document.getElementById('log-viewer').innerHTML =
			'<div class="log-error">Error loading logs</div>';
	}
}

// Perform action
async function performAction(action) {
	if (!confirm(`Are you sure you want to ${action.replace('_', ' ')}?`)) return;

	try {
		const formData = new FormData();
		formData.append('action', action);

		const resp = await fetch(API_BASE + '/action', {
			method: 'POST',
			body: formData
		});
		const result = await resp.json();

		if (result.success) {
			alert('Success: ' + result.message);
			setTimeout(loadDashboard, 900);
		} else {
			alert('Error: ' + result.message);
		}
	} catch (error) {
		alert('Error: ' + error.message);
	}
}

// Clear logs
async function clearLogs() {
	if (!confirm('Are you sure you want to clear all logs?')) return;
	await performAction('clear_logs');
	await refreshLogs();
}

// Escape HTML
function escapeHtml(text) {
	const div = document.createElement('div');
	div.textContent = text;
	return div.innerHTML;
}

// Auto-refresh every 30s
setInterval(loadDashboard, 30000);
loadDashboard();
</script>

<%+footer%>
