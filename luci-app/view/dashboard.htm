<%#
Copyright 2025 Matsumiko
Licensed under the Apache License, Version 2.0
-%>

<%+header%>

<style>
/* Argon Theme Compatibility */
.autoedu-dashboard {
	max-width: 1200px;
	margin: 0 auto;
}

/* Override Argon dark backgrounds */
.status-card {
	background: var(--cbi-section-background, #fff);
	border: 1px solid var(--border-color, #ddd);
	border-radius: 8px;
	padding: 20px;
	margin-bottom: 20px;
	box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-card h3 {
	margin-top: 0;
	color: var(--primary-text-color, #333);
	border-bottom: 2px solid var(--primary-color, #007bff);
	padding-bottom: 10px;
}

.status-indicator {
	display: inline-block;
	width: 12px;
	height: 12px;
	border-radius: 50%;
	margin-right: 8px;
	animation: pulse 2s infinite;
}

@keyframes pulse {
	0%, 100% { opacity: 1; }
	50% { opacity: 0.5; }
}

.status-running { 
	background: #28a745;
	box-shadow: 0 0 8px #28a745;
}

.status-stopped { 
	background: #dc3545;
	box-shadow: 0 0 8px #dc3545;
}

.status-info {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
	gap: 15px;
	margin-top: 15px;
}

.info-item {
	padding: 15px;
	background: var(--secondary-background, #f8f9fa);
	border-radius: 6px;
	border: 1px solid var(--border-color, #e0e0e0);
	transition: all 0.3s ease;
}

.info-item:hover {
	transform: translateY(-2px);
	box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.info-label {
	font-weight: bold;
	color: var(--secondary-text-color, #666);
	font-size: 0.9em;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}

.info-value {
	color: var(--primary-text-color, #333);
	font-size: 1.1em;
	margin-top: 8px;
	font-weight: 500;
}

.btn-group {
	display: flex;
	gap: 10px;
	margin-top: 15px;
	flex-wrap: wrap;
}

.btn {
	padding: 10px 20px;
	border: none;
	border-radius: 6px;
	cursor: pointer;
	font-size: 14px;
	font-weight: 500;
	transition: all 0.3s;
	text-decoration: none;
	display: inline-block;
}

.btn-primary { 
	background: var(--primary-color, #007bff); 
	color: white; 
}

.btn-success { 
	background: #28a745; 
	color: white; 
}

.btn-danger { 
	background: #dc3545; 
	color: white; 
}

.btn-warning { 
	background: #ffc107; 
	color: #333; 
}

.btn:hover { 
	opacity: 0.9;
	transform: translateY(-1px);
	box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn:disabled { 
	opacity: 0.5; 
	cursor: not-allowed;
	transform: none;
}

.stats-grid {
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
	gap: 15px;
	margin-top: 15px;
}

.stat-box {
	text-align: center;
	padding: 20px 15px;
	background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
	color: white;
	border-radius: 10px;
	box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	transition: transform 0.3s;
}

.stat-box:hover {
	transform: translateY(-5px);
}

.stat-value {
	font-size: 2.5em;
	font-weight: bold;
	text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.stat-label {
	font-size: 0.9em;
	opacity: 0.95;
	margin-top: 8px;
	text-transform: uppercase;
	letter-spacing: 1px;
}

.mode-badge {
	display: inline-block;
	padding: 6px 16px;
	border-radius: 20px;
	font-weight: bold;
	font-size: 0.95em;
	letter-spacing: 0.5px;
}

.mode-efficient {
	background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
	color: #155724;
	border: 2px solid #b1dfbb;
	box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
}

.mode-aggressive {
	background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
	color: #721c24;
	border: 2px solid #f1b0b7;
	box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
}

/* Log viewer with Argon theme support */
.log-viewer {
	background: var(--code-background, #1e1e1e);
	color: var(--code-text-color, #d4d4d4);
	padding: 15px;
	border-radius: 8px;
	font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
	font-size: 0.9em;
	max-height: 400px;
	overflow-y: auto;
	margin-top: 15px;
	border: 1px solid var(--border-color, #333);
	box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.log-line {
	margin: 3px 0;
	line-height: 1.5;
	padding: 2px 0;
}

.log-info { color: #4fc3f7; }
.log-success { color: #81c784; }
.log-warn { color: #ffb74d; }
.log-error { color: #e57373; }

.loading {
	text-align: center;
	padding: 30px;
	color: var(--secondary-text-color, #666);
	font-style: italic;
}

/* Scrollbar styling */
.log-viewer::-webkit-scrollbar {
	width: 8px;
}

.log-viewer::-webkit-scrollbar-track {
	background: #2d2d2d;
	border-radius: 4px;
}

.log-viewer::-webkit-scrollbar-thumb {
	background: #555;
	border-radius: 4px;
}

.log-viewer::-webkit-scrollbar-thumb:hover {
	background: #777;
}

/* Responsive */
@media (max-width: 768px) {
	.status-info {
		grid-template-columns: 1fr;
	}
	
	.btn-group {
		flex-direction: column;
	}
	
	.btn {
		width: 100%;
	}
}
</style>

<div class="autoedu-dashboard">
	<h2>ü§ñ Auto-Edu Dashboard</h2>
	
	<!-- Service Status Card -->
	<div class="status-card">
		<h3>Service Status</h3>
		<div id="service-status" class="loading">Loading...</div>
		
		<div class="btn-group" id="action-buttons" style="display:none;">
			<button class="btn btn-success" onclick="performAction('start')" id="btn-start">
				‚ñ∂Ô∏è Start Service
			</button>
			<button class="btn btn-danger" onclick="performAction('stop')" id="btn-stop">
				‚è∏ Stop Service
			</button>
			<button class="btn btn-warning" onclick="performAction('restart')">
				üîÑ Restart Service
			</button>
			<button class="btn btn-primary" onclick="performAction('run_now')">
				‚ñ∂Ô∏è Run Now
			</button>
		</div>
	</div>
	
	<!-- Current Configuration Card -->
	<div class="status-card">
		<h3>Current Configuration</h3>
		<div id="config-info" class="loading">Loading...</div>
	</div>
	
	<!-- Statistics Card -->
	<div class="status-card">
		<h3>Statistics (Last 24h)</h3>
		<div id="statistics" class="loading">Loading...</div>
	</div>
	
	<!-- Recent Logs Card -->
	<div class="status-card">
		<h3>Recent Activity</h3>
		<div class="btn-group">
			<button class="btn btn-primary" onclick="refreshLogs()">üîÑ Refresh</button>
			<button class="btn btn-danger" onclick="clearLogs()">üóë Clear Logs</button>
			<a href="<%=url("admin/services/autoedu/logs")%>" class="btn btn-primary">üìú View Full Logs</a>
		</div>
		<div class="log-viewer" id="log-viewer">
			<div class="loading">Loading logs...</div>
		</div>
	</div>
</div>

<script>
// API base URL
const API_BASE = '<%=url("admin/services/autoedu/api")%>';

// Load dashboard data
async function loadDashboard() {
	try {
		// Load service status
		const statusResp = await fetch(API_BASE + '/status');
		const status = await statusResp.json();
		renderStatus(status);
		
		// Load statistics
		const statsResp = await fetch(API_BASE + '/stats');
		const stats = await statsResp.json();
		renderStats(stats);
		
		// Load recent logs
		await refreshLogs();
		
	} catch (error) {
		console.error('Error loading dashboard:', error);
	}
}

// Render service status
function renderStatus(status) {
	const statusDiv = document.getElementById('service-status');
	const actionButtons = document.getElementById('action-buttons');
	
	const modeClass = status.mode === 'AGGRESSIVE' ? 'mode-aggressive' : 'mode-efficient';
	const modeIcon = status.mode === 'AGGRESSIVE' ? 'üî¥' : 'üü¢';
	const modeText = status.mode === 'AGGRESSIVE' ? 'AGGRESSIVE' : 'EFFICIENT';
	
	// More accurate status check
	const isRunning = status.enabled && status.cron_active;
	const statusIcon = isRunning ? 
		'<span class="status-indicator status-running"></span>Running' :
		'<span class="status-indicator status-stopped"></span>Stopped';
	
	const statusColor = isRunning ? '#28a745' : '#dc3545';
	
	statusDiv.innerHTML = `
		<div class="status-info">
			<div class="info-item">
				<div class="info-label">Status</div>
				<div class="info-value" style="color: ${statusColor}; font-weight: bold;">${statusIcon}</div>
				<div style="font-size: 0.85em; color: #666; margin-top: 5px;">
					${status.enabled ? '‚úì Enabled in config' : '‚úó Disabled in config'}<br>
					${status.cron_active ? '‚úì Cron job active' : '‚úó No cron job'}
				</div>
			</div>
			<div class="info-item">
				<div class="info-label">Mode</div>
				<div class="info-value">
					<span class="mode-badge ${modeClass}">${modeIcon} ${modeText}</span>
				</div>
			</div>
			<div class="info-item">
				<div class="info-label">Last Check</div>
				<div class="info-value">${status.last_check || 'Never'}</div>
				${status.last_check_ago ? '<div style="font-size: 0.85em; color: #666; margin-top: 3px;">' + status.last_check_ago + '</div>' : ''}
			</div>
			<div class="info-item">
				<div class="info-label">Last Renewal</div>
				<div class="info-value">${status.last_renewal || 'Never'}</div>
				${status.last_renewal_ago ? '<div style="font-size: 0.85em; color: #666; margin-top: 3px;">' + status.last_renewal_ago + '</div>' : ''}
			</div>
			<div class="info-item">
				<div class="info-label">Cron Schedule</div>
				<div class="info-value">${status.cron_readable || 'Not configured'}</div>
				${status.next_check ? '<div style="font-size: 0.85em; color: #666; margin-top: 3px;">Next: ' + status.next_check + '</div>' : ''}
			</div>
			<div class="info-item">
				<div class="info-label">ADB Device</div>
				<div class="info-value">${status.adb_connected ? '‚úÖ ' + (status.adb_device || 'Connected') : '‚ùå Disconnected'}</div>
			</div>
		</div>
	`;
	
	// Show/hide buttons based on status
	actionButtons.style.display = 'flex';
	document.getElementById('btn-start').disabled = isRunning;
	document.getElementById('btn-stop').disabled = !isRunning;
	
	// Render config info
	const configDiv = document.getElementById('config-info');
	
	configDiv.innerHTML = `
		<div class="status-info">
			<div class="info-item">
				<div class="info-label">Telegram Bot</div>
				<div class="info-value">${status.telegram_configured ? '‚úÖ Configured' : '‚ùå Not configured'}</div>
			</div>
			<div class="info-item">
				<div class="info-label">Service</div>
				<div class="info-value">${status.enabled ? '‚úÖ Enabled' : '‚ùå Disabled'}</div>
			</div>
			<div class="info-item">
				<div class="info-label">Auto Start</div>
				<div class="info-value">${status.cron_active ? '‚úÖ Active' : '‚ùå Inactive'}</div>
			</div>
		</div>
		<div class="btn-group">
			<a href="<%=url("admin/services/autoedu/config")%>" class="btn btn-primary">‚úèÔ∏è Edit Configuration</a>
			<a href="<%=url("admin/services/autoedu/mode")%>" class="btn btn-warning">üéöÔ∏è Change Mode</a>
		</div>
	`;
}

// Render statistics
function renderStats(stats) {
	const statsDiv = document.getElementById('statistics');
	
	statsDiv.innerHTML = `
		<div class="stats-grid">
			<div class="stat-box">
				<div class="stat-value">${stats.checks_24h || 0}</div>
				<div class="stat-label">Total Checks</div>
			</div>
			<div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
				<div class="stat-value">${stats.renewals_24h || 0}</div>
				<div class="stat-label">Renewals</div>
			</div>
			<div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
				<div class="stat-value">${stats.success_rate || 100}%</div>
				<div class="stat-label">Success Rate</div>
			</div>
		</div>
	`;
}

// Refresh logs
async function refreshLogs() {
	try {
		const resp = await fetch(API_BASE + '/logs?lines=50');
		const data = await resp.json();
		
		const logViewer = document.getElementById('log-viewer');
		
		if (data.success && data.logs.length > 0) {
			logViewer.innerHTML = data.logs.map(line => {
				let className = 'log-line';
				if (line.includes('[ERROR]')) className += ' log-error';
				else if (line.includes('[WARN]')) className += ' log-warn';
				else if (line.includes('[SUCCESS]')) className += ' log-success';
				else if (line.includes('[INFO]')) className += ' log-info';
				
				return `<div class="${className}">${escapeHtml(line)}</div>`;
			}).join('');
			
			// Auto-scroll to bottom
			logViewer.scrollTop = logViewer.scrollHeight;
		} else {
			logViewer.innerHTML = '<div class="loading">No logs available</div>';
		}
	} catch (error) {
		console.error('Error loading logs:', error);
		document.getElementById('log-viewer').innerHTML = 
			'<div class="log-error">Error loading logs</div>';
	}
}

// Perform action
async function performAction(action) {
	if (!confirm(`Are you sure you want to ${action.replace('_', ' ')}?`)) {
		return;
	}
	
	try {
		const formData = new FormData();
		formData.append('action', action);
		
		const resp = await fetch(API_BASE + '/action', {
			method: 'POST',
			body: formData
		});
		
		const result = await resp.json();
		
		if (result.success) {
			alert('Success: ' + result.message);
			// Reload dashboard after action
			setTimeout(loadDashboard, 1000);
		} else {
			alert('Error: ' + result.message);
		}
	} catch (error) {
		alert('Error: ' + error.message);
	}
}

// Clear logs
async function clearLogs() {
	if (!confirm('Are you sure you want to clear all logs?')) {
		return;
	}
	
	await performAction('clear_logs');
	await refreshLogs();
}

// Utility: Escape HTML
function escapeHtml(text) {
	const div = document.createElement('div');
	div.textContent = text;
	return div.innerHTML;
}

// Auto-refresh every 30 seconds
setInterval(loadDashboard, 30000);

// Initial load
loadDashboard();
</script>

<%+footer%>
